---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import BlogHero from '../../components/blog/BlogHero.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import BlogPagination from '../../components/blog/BlogPagination.astro';

export const getStaticPaths = (async ({ paginate }) => {
  // Get all blog posts, filter out drafts, and sort by publish date
  const allPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });

  // Sort by publish date (newest first)
  const sortedPosts = allPosts.sort((a, b) => {
    return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
  });

  // Paginate with 9 posts per page
  return paginate(sortedPosts, { pageSize: 9 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const { data: posts, currentPage, lastPage, url } = page;

// Get featured posts (only on page 1)
const featuredPosts = currentPage === 1 ? posts.filter((post) => post.data.featured).slice(0, 2) : [];
const regularPosts = currentPage === 1 ? posts.filter((post) => !post.data.featured) : posts;

// Get unique categories for filter
const allPosts = await getCollection('blog', ({ data }) => data.draft !== true);
const categories = [...new Set(allPosts.map((post) => post.data.category))];

// SEO
const title = currentPage === 1 ? 'SEO Insights & Digital Marketing Resources | Digital Growth Experts' : `SEO Blog - Page ${currentPage} | Digital Growth Experts`;
const description = 'Expert SEO strategies, tips, and insights to help Australian businesses dominate search rankings and drive sustainable growth.';
const canonical = currentPage === 1 ? `${Astro.site}blog/` : `${Astro.site}blog/${currentPage}/`;
---

<BaseLayout
  title={title}
  description={description}
  canonical={canonical}
  ogType="website"
  schema={{
    type: 'Organization',
    data: {
      '@type': 'Blog',
      name: 'Digital Growth Experts Blog',
      description: description,
    },
  }}
>
  <Header />

  <main id="main-content">
    <!-- Hero Section -->
    <BlogHero
      title="SEO Insights & Resources"
      subtitle="Expert strategies, tips, and insights to help your business dominate search rankings and achieve sustainable growth."
      categories={categories}
    />

    <!-- Featured Posts Section (Page 1 Only) -->
    {featuredPosts.length > 0 && (
      <section class="section-padding bg-white">
        <div class="container-custom">
          <div class="mb-8">
            <h2 class="text-2xl md:text-3xl font-bold font-display text-gray-900">Featured Articles</h2>
          </div>
          <div class="grid md:grid-cols-2 gap-8">
            {featuredPosts.map((post) => (
              <BlogCard post={post} variant="featured" />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Regular Posts Grid -->
    <section class="section-padding bg-gray-50">
      <div class="container-custom">
        {currentPage > 1 && (
          <div class="mb-8">
            <h2 class="text-2xl md:text-3xl font-bold font-display text-gray-900">Latest Articles</h2>
          </div>
        )}

        {regularPosts.length > 0 ? (
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {regularPosts.map((post) => (
              <BlogCard post={post} variant="regular" />
            ))}
          </div>
        ) : (
          <div class="text-center py-12">
            <p class="text-xl text-gray-600">No blog posts found.</p>
          </div>
        )}

        <!-- Pagination -->
        {lastPage > 1 && (
          <div class="mt-12">
            <BlogPagination
              currentPage={currentPage}
              totalPages={lastPage}
              basePath="/blog"
            />
          </div>
        )}
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<style>
  .section-padding {
    padding: 4rem 0;
  }

  @media (min-width: 768px) {
    .section-padding {
      padding: 6rem 0;
    }
  }

  @media (min-width: 1024px) {
    .section-padding {
      padding: 8rem 0;
    }
  }

  .container-custom {
    max-width: 80rem;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  @media (min-width: 640px) {
    .container-custom {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .container-custom {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }
</style>
