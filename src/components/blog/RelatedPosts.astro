---
import { getCollection } from 'astro:content';
import BlogCard from './BlogCard.astro';

interface Props {
  currentSlug: string;
  currentCategory: string;
  currentTags: string[];
  limit?: number;
}

const { currentSlug, currentCategory, currentTags, limit = 3 } = Astro.props;

// Get all published posts except the current one
const allPosts = await getCollection('blog', ({ data, id }) => {
  return data.draft !== true && id !== currentSlug;
});

// Score posts based on relevance
const scoredPosts = allPosts.map((post) => {
  let score = 0;

  // Same category gets high score
  if (post.data.category === currentCategory) {
    score += 10;
  }

  // Each matching tag gets points
  const matchingTags = post.data.tags.filter((tag) => currentTags.includes(tag));
  score += matchingTags.length * 3;

  // Featured posts get a small bonus
  if (post.data.featured) {
    score += 1;
  }

  // Newer posts get small bonus
  const daysSincePublish = (Date.now() - new Date(post.data.publishDate).getTime()) / (1000 * 60 * 60 * 24);
  if (daysSincePublish < 30) {
    score += 2;
  } else if (daysSincePublish < 90) {
    score += 1;
  }

  return { post, score };
});

// Sort by score and take top N
const relatedPosts = scoredPosts
  .sort((a, b) => b.score - a.score)
  .slice(0, limit)
  .map((item) => item.post);

// If we don't have enough related posts, fill with recent posts
if (relatedPosts.length < limit) {
  const recentPosts = allPosts
    .filter((post) => !relatedPosts.includes(post))
    .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
    .slice(0, limit - relatedPosts.length);

  relatedPosts.push(...recentPosts);
}
---

{relatedPosts.length > 0 && (
  <div>
    <h2 class="text-2xl md:text-3xl font-bold font-display text-gray-900 mb-8 text-center">
      You Might Also Like
    </h2>
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
      {relatedPosts.map((post) => (
        <BlogCard post={post} variant="regular" />
      ))}
    </div>
  </div>
)}
