---
interface Props {
  headings: {
    depth: number;
    text: string;
    slug: string;
  }[];
}

const { headings } = Astro.props;

// Filter to only show H2 and H3 headings
const tocHeadings = headings.filter((h) => h.depth <= 3);
---

{tocHeadings.length > 0 && (
  <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
    <h3 class="text-lg font-bold font-display text-gray-900 mb-4 flex items-center gap-2">
      <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
      </svg>
      In This Article
    </h3>
    <nav class="toc-nav">
      <ul class="space-y-2 no-list-style">
        {tocHeadings.map((heading) => (
          <li class={heading.depth === 3 ? 'ml-4' : ''}>
            <a
              href={`#${heading.slug}`}
              class="toc-link text-sm text-gray-600 hover:text-primary-600 transition-colors block py-1"
              data-slug={heading.slug}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
)}

<script>
  // Highlight active section in TOC
  const observerOptions = {
    rootMargin: '-80px 0px -66% 0px',
    threshold: 0,
  };

  const headingObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const id = entry.target.getAttribute('id');
      const tocLink = document.querySelector(`.toc-link[data-slug="${id}"]`);

      if (tocLink) {
        if (entry.isIntersecting) {
          // Remove active class from all links
          document.querySelectorAll('.toc-link').forEach((link) => {
            link.classList.remove('active', 'font-bold', 'text-primary-600');
            link.classList.add('text-gray-600');
          });

          // Add active class to current link
          tocLink.classList.add('active', 'font-bold', 'text-primary-600');
          tocLink.classList.remove('text-gray-600');
        }
      }
    });
  }, observerOptions);

  // Observe all headings
  document.querySelectorAll('article h2, article h3').forEach((heading) => {
    headingObserver.observe(heading);
  });

  // Smooth scroll behavior
  document.querySelectorAll('.toc-link').forEach((link) => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const targetId = link.getAttribute('href')?.substring(1);
      const targetElement = document.getElementById(targetId || '');

      if (targetElement) {
        const offset = 100; // Account for fixed header
        const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - offset;

        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth',
        });
      }
    });
  });
</script>

<style>
  .toc-link.active {
    position: relative;
  }

  .toc-link.active::before {
    content: '';
    position: absolute;
    left: -1rem;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 20px;
    background: #3c8bda;
    border-radius: 2px;
  }
</style>
