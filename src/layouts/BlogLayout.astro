---
import BaseLayout from './BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import BreadcrumbNav from '../components/blog/BreadcrumbNav.astro';
import TableOfContents from '../components/blog/TableOfContents.astro';
import SocialShare from '../components/blog/SocialShare.astro';
import AuthorBio from '../components/blog/AuthorBio.astro';
import RelatedPosts from '../components/blog/RelatedPosts.astro';
import BlogCTA from '../components/blog/BlogCTA.astro';
import CategoryBadge from '../components/blog/CategoryBadge.astro';
import CTASection from '../components/sections/CTASection.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'blog'>;
  headings: {
    depth: number;
    text: string;
    slug: string;
  }[];
}

const { post, headings } = Astro.props;
const { title, description, publishDate, updatedDate, author, category, tags, image, imageAlt, metaTitle, metaDescription } = post.data;

// Format dates
const formattedDate = new Date(publishDate).toLocaleDateString('en-AU', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const formattedUpdatedDate = updatedDate
  ? new Date(updatedDate).toLocaleDateString('en-AU', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    })
  : null;

// Calculate read time (approximate)
// Estimate based on description length (will be more accurate in production with actual content)
const estimatedWordCount = description.split(' ').length * 10; // Rough estimate
const readTime = Math.ceil(estimatedWordCount / 200); // 200 words per minute

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Blog', href: '/blog/' },
  { label: title, href: `/blog/${post.id}/` },
];

// Full URL for social sharing
const fullUrl = `${Astro.site}blog/${post.id}/`;

// SEO meta
const seoTitle = metaTitle || `${title} | Digital Growth Experts`;
const seoDescription = metaDescription || description;
const ogImage = image ? new URL(image.src, Astro.site).toString() : `${Astro.site}images/team-hero.png`;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  canonical={fullUrl}
  ogImage={ogImage}
  ogType="article"
  schema={{
    type: 'Article',
    data: {
      '@type': 'BlogPosting',
      headline: title,
      description: description,
      image: [ogImage],
      datePublished: publishDate.toISOString(),
      dateModified: (updatedDate || publishDate).toISOString(),
      author: {
        '@type': 'Person',
        name: author,
      },
      publisher: {
        '@type': 'Organization',
        name: 'Digital Growth Experts',
        logo: {
          '@type': 'ImageObject',
          url: `${Astro.site}images/logo.png`,
        },
      },
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': fullUrl,
      },
      articleSection: category,
      keywords: tags.join(', '),
      wordCount: estimatedWordCount,
      inLanguage: 'en-AU',
    },
  }}
>
  <!-- Breadcrumb Schema in head -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: breadcrumbs.map((item, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      name: item.label,
      item: `${Astro.site}${item.href.replace(/^\//, '')}`,
    })),
  })} />

  <Header />

  <main id="main-content">
    <!-- Article Hero Section -->
    <section class="relative py-16 md:py-20 lg:py-24 overflow-hidden">
      <!-- Background Image with Overlay -->
      <div class="absolute inset-0 z-0">
        <img
          src={image?.src || '/images/team-hero.png'}
          alt=""
          class="w-full h-full object-cover object-center"
          loading="eager"
        />
        <!-- Gradient Overlay for Readability and Brand Consistency -->
        <div class="absolute inset-0 bg-gradient-to-br from-primary-900/95 via-primary-800/90 to-secondary-900/95"></div>
      </div>

      <div class="container-custom relative z-10">
        <div class="max-w-4xl mx-auto">
          <!-- Breadcrumbs -->
          <BreadcrumbNav items={breadcrumbs} />

          <!-- Category Badge -->
          <div class="mb-4">
            <CategoryBadge category={category} clickable={true} />
          </div>

          <!-- Title -->
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold font-display text-white mb-6 leading-tight">
            {title}
          </h1>

          <!-- Meta Information -->
          <div class="flex flex-wrap items-center gap-4 text-sm text-white/80 mb-6">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
              <span class="font-medium">{author}</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <time datetime={publishDate.toISOString()} class="font-medium">{formattedDate}</time>
            </div>
            {formattedUpdatedDate && (
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span class="font-medium">Updated {formattedUpdatedDate}</span>
              </div>
            )}
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-white/90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="font-medium">{readTime} min read</span>
            </div>
          </div>

          <!-- Social Share (Top) -->
          <SocialShare title={title} url={fullUrl} position="top" />
        </div>
      </div>
    </section>

    <!-- Article Content with Sidebar -->
    <section class="section-padding bg-white">
      <div class="container-custom">
        <div class="max-w-7xl mx-auto">
          <div class="grid lg:grid-cols-3 gap-8 lg:gap-12">
            <!-- Main Content Area (2/3) -->
            <article class="lg:col-span-2 prose prose-lg max-w-none">
              <slot />
            </article>

            <!-- Sticky Sidebar (1/3) -->
            <aside class="lg:col-span-1">
              <div class="sticky top-24 space-y-6">
                <!-- Table of Contents -->
                {headings.length > 0 && (
                  <TableOfContents headings={headings} />
                )}

                <!-- Author Bio (Small) -->
                <AuthorBio
                  author={{
                    name: author,
                    role: 'SEO Expert',
                    bio: 'Helping Australian businesses dominate search rankings and drive sustainable growth through proven SEO strategies.',
                    avatar: undefined,
                    social: {
                      linkedin: 'https://www.linkedin.com/company/digital-growth-experts',
                    },
                  }}
                  variant="small"
                  showViewAll={true}
                />

                <!-- Category & Tags -->
                <div class="bg-gray-50 rounded-xl p-6">
                  <h3 class="text-lg font-bold font-display text-gray-900 mb-4">Topics</h3>
                  <div class="space-y-3">
                    <div>
                      <p class="text-sm font-semibold text-gray-700 mb-2">Category</p>
                      <CategoryBadge category={category} clickable={true} />
                    </div>
                    {tags.length > 0 && (
                      <div>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Tags</p>
                        <div class="flex flex-wrap gap-2">
                          {tags.map((tag) => (
                            <span class="inline-block px-3 py-1 bg-white border border-gray-200 text-sm text-gray-700 rounded-full hover:border-primary-300 transition-colors">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <!-- CTA Box -->
                <BlogCTA
                  variant="sidebar"
                  title="Need Help with SEO?"
                  description="Get a free strategy session and discover how we can boost your rankings."
                  ctaText="Book Free Consultation"
                  ctaHref="/contact/"
                />
              </div>
            </aside>
          </div>
        </div>
      </div>
    </section>

    <!-- Social Share (Bottom) -->
    <section class="bg-gray-50 py-8">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto text-center">
          <p class="text-lg font-semibold text-gray-900 mb-4">Found this helpful? Share it!</p>
          <SocialShare title={title} url={fullUrl} position="bottom" />
        </div>
      </div>
    </section>

    <!-- Author Bio (Large) -->
    <section class="bg-white py-12">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto">
          <AuthorBio
            author={{
              name: author,
              role: 'SEO Expert & Digital Marketing Specialist',
              bio: 'With over 10 years of experience in search engine optimization and digital marketing, our team has helped hundreds of Australian businesses dominate search rankings and achieve sustainable growth. We specialize in data-driven SEO strategies that deliver measurable results and long-term success.',
              avatar: undefined,
              social: {
                linkedin: 'https://www.linkedin.com/company/digital-growth-experts',
              },
            }}
            variant="large"
            showViewAll={true}
          />
        </div>
      </div>
    </section>

    <!-- Related Posts -->
    <section class="section-padding bg-gray-50">
      <div class="container-custom">
        <RelatedPosts
          currentSlug={post.id}
          currentCategory={category}
          currentTags={tags}
          limit={3}
        />
      </div>
    </section>

    <!-- Final Conversion CTA -->
    <CTASection
      title="Ready to Dominate Search Rankings?"
      subtitle="Get your free SEO audit and discover the exact strategies we'll use to boost your rankings, increase traffic, and grow your business. No obligations, just actionable insights from our expert SEO team."
      primaryCTA={{
        text: 'Free Strategy Session',
        href: '/contact/',
      }}
    />
  </main>

  <Footer />
</BaseLayout>

<style>
  .section-padding {
    padding: 4rem 0;
  }

  @media (min-width: 768px) {
    .section-padding {
      padding: 6rem 0;
    }
  }

  @media (min-width: 1024px) {
    .section-padding {
      padding: 8rem 0;
    }
  }

  .container-custom {
    max-width: 80rem;
    margin-left: auto;
    margin-right: auto;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  @media (min-width: 640px) {
    .container-custom {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .container-custom {
      padding-left: 2rem;
      padding-right: 2rem;
    }
  }

  /* Prose Styling for Article Content */
  :global(.prose) {
    color: #464646;
    max-width: none;
  }

  :global(.prose h2) {
    color: #1a1a1a;
    font-family: 'Poppins', 'Inter', sans-serif;
    font-weight: 700;
    font-size: clamp(1.5rem, 1.3rem + 1vw, 2rem);
    margin-top: 2em;
    margin-bottom: 1em;
    line-height: 1.3;
  }

  :global(.prose h3) {
    color: #1a1a1a;
    font-family: 'Poppins', 'Inter', sans-serif;
    font-weight: 700;
    font-size: clamp(1.25rem, 1.1rem + 0.75vw, 1.5rem);
    margin-top: 1.6em;
    margin-bottom: 0.8em;
    line-height: 1.4;
  }

  :global(.prose h4) {
    color: #1a1a1a;
    font-family: 'Poppins', 'Inter', sans-serif;
    font-weight: 600;
    font-size: clamp(1.125rem, 1rem + 0.5vw, 1.25rem);
    margin-top: 1.4em;
    margin-bottom: 0.7em;
  }

  :global(.prose p) {
    margin-bottom: 1.5em;
    line-height: 1.75;
  }

  :global(.prose a) {
    color: #3c8bda;
    font-weight: 600;
    text-decoration: none;
    transition: color 0.2s;
  }

  :global(.prose a:hover) {
    color: #2d6bb0;
    text-decoration: underline;
  }

  :global(.prose strong) {
    color: #1a1a1a;
    font-weight: 700;
  }

  /* ===== UNORDERED LISTS - Conversion-Optimized ===== */
  :global(.prose ul) {
    margin: 1.75em 0;
    padding-left: 0;
    list-style: none;
  }

  :global(.prose li) {
    position: relative;
    margin: 0.75em 0;
    padding-left: 2em;
    line-height: 1.75;
    color: #464646;
  }

  /* Custom checkmark bullet for unordered lists */
  :global(.prose ul > li::before) {
    content: '';
    position: absolute;
    left: 0;
    top: 0.5em;
    width: 1.25em;
    height: 1.25em;
    background-color: #3c8bda;
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
    -webkit-mask-size: contain;
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-position: center;
    flex-shrink: 0;
  }

  /* Nested list support - different icon and color */
  :global(.prose ul ul > li::before) {
    background-color: #3eb875;
    width: 1em;
    height: 1em;
    top: 0.6em;
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 18 15 12 9 6'%3E%3C/polyline%3E%3C/svg%3E");
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='9 18 15 12 9 6'%3E%3C/polyline%3E%3C/svg%3E");
  }

  :global(.prose ul ul) {
    margin: 0.5em 0;
    padding-left: 1.5em;
  }

  /* Third level nesting - simple dot */
  :global(.prose ul ul ul > li::before) {
    background-color: #FFA708;
    width: 0.5em;
    height: 0.5em;
    top: 0.75em;
    border-radius: 50%;
    mask-image: none;
    -webkit-mask-image: none;
  }

  /* ===== ORDERED LISTS - Conversion-Optimized ===== */
  :global(.prose ol) {
    margin: 1.75em 0;
    padding-left: 0;
    list-style: none;
    counter-reset: list-counter;
  }

  :global(.prose ol > li) {
    position: relative;
    margin: 0.75em 0;
    padding-left: 2.5em;
    counter-increment: list-counter;
    line-height: 1.75;
    color: #464646;
  }

  /* Custom numbered bullets with brand styling */
  :global(.prose ol > li::before) {
    content: counter(list-counter);
    position: absolute;
    left: 0;
    top: 0;
    width: 1.75em;
    height: 1.75em;
    background: linear-gradient(135deg, #3c8bda 0%, #2d6bb0 100%);
    color: white;
    font-weight: 700;
    font-size: 0.875em;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(60, 139, 218, 0.2);
    font-family: 'Poppins', 'Inter', sans-serif;
  }

  /* Nested ordered lists - different style */
  :global(.prose ol ol) {
    margin: 0.5em 0;
    padding-left: 1.5em;
    counter-reset: nested-counter;
  }

  :global(.prose ol ol > li) {
    counter-increment: nested-counter;
    padding-left: 2.25em;
  }

  :global(.prose ol ol > li::before) {
    content: counter(nested-counter, lower-alpha);
    background: linear-gradient(135deg, #3eb875 0%, #2f8b5a 100%);
    width: 1.5em;
    height: 1.5em;
    font-size: 0.75em;
  }

  /* Third level ordered lists */
  :global(.prose ol ol ol) {
    counter-reset: deep-counter;
  }

  :global(.prose ol ol ol > li) {
    counter-increment: deep-counter;
  }

  :global(.prose ol ol ol > li::before) {
    content: counter(deep-counter, lower-roman);
    background: linear-gradient(135deg, #FFA708 0%, #cc8606 100%);
    width: 1.5em;
    height: 1.5em;
    font-size: 0.7em;
  }

  /* Mixed nested lists (ol inside ul, ul inside ol) */
  :global(.prose ul ol) {
    margin: 0.5em 0;
    padding-left: 1.5em;
  }

  :global(.prose ol ul) {
    margin: 0.5em 0;
    padding-left: 1.5em;
  }

  /* Hover effect for better interactivity */
  :global(.prose li) {
    transition: transform 0.2s ease, color 0.2s ease;
  }

  :global(.prose li:hover) {
    transform: translateX(4px);
  }

  /* Strong text within lists for emphasis */
  :global(.prose li strong) {
    color: #1a1a1a;
    font-weight: 700;
  }

  /* Links within lists */
  :global(.prose li a) {
    color: #3c8bda;
    font-weight: 600;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s, color 0.2s;
  }

  :global(.prose li a:hover) {
    color: #2d6bb0;
    border-bottom-color: #2d6bb0;
  }

  :global(.prose blockquote) {
    border-left: 4px solid #3c8bda;
    background: #e8f2fa;
    padding: 1.5em;
    margin: 2em 0;
    font-style: italic;
    border-radius: 0.5rem;
  }

  :global(.prose img) {
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    margin: 2em auto;
  }

  :global(.prose code) {
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: 'Courier New', monospace;
  }

  :global(.prose pre) {
    background: #1a1a1a;
    color: #f5f5f5;
    padding: 1.5em;
    border-radius: 0.75rem;
    overflow-x: auto;
    margin: 2em 0;
  }

  :global(.prose pre code) {
    background: transparent;
    border: none;
    padding: 0;
    color: inherit;
  }

  :global(.prose table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2em 0;
  }

  :global(.prose th) {
    background: #3c8bda;
    color: white;
    padding: 0.75em;
    text-align: left;
    font-weight: 600;
  }

  :global(.prose td) {
    padding: 0.75em;
    border: 1px solid #e0e0e0;
  }

  :global(.prose tr:nth-child(even)) {
    background: #f5f5f5;
  }
</style>
